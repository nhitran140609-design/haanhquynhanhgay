<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quiz CNXH ‚Äî C√≥ h√¨nh + √¢m (t√™n file ƒë√£ ƒë∆∞·ª£c append)</title>
<style>
  body{margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#f3f8ff;font-family:Arial,Helvetica,sans-serif}
  #wrap{width:880px;padding:18px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.08);text-align:center}
  canvas{display:block;margin:0 auto;border-radius:8px;background:#ffffff;border:2px solid #ccc}
  #result{height:34px;margin:10px 0;font-weight:700;font-size:20px}
  .controls{margin-top:8px}
  button{padding:8px 14px;margin:0 6px;border:none;border-radius:6px;background:#1e88e5;color:#fff;cursor:pointer;font-size:15px}
  button.secondary{background:#6c757d}
  .hint{color:#666;margin-top:6px}
</style>
</head>
<body>
  <div id="wrap">
    <h2>Quiz: X√¢y d·ª±ng CNXH</h2>
    <canvas id="gameCanvas" width="800" height="520"></canvas>
    <div id="result"></div>

    <!-- Audio elements: t√™n file ƒë√£ append theo y√™u c·∫ßu -->
    <audio id="correctSound" src="correct.mp3.mp4"></audio>
    <audio id="wrongSound"   src="wrong.mp3.mp4"></audio>
    <audio id="bgMusic"      src="bgmusic.mp3.mp4" loop></audio>

    <div class="controls">
      <button id="musicBtn">üîä B·∫≠t/T·∫Øt nh·∫°c</button>
      <button id="restartBtn" class="secondary">üîÅ Ch∆°i l·∫°i</button>
    </div>
    <div class="hint">Nh·∫•n ph√≠m 1 - 4 ƒë·ªÉ ch·ªçn ƒë√°p √°n. N·∫øu thi·∫øu ·∫£nh/√¢m thanh, game v·∫´n ch·∫°y (c√≥ fallback).</div>
  </div>

<script>
/* ========== Setup ========== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const resultDiv = document.getElementById('result');
const restartBtn = document.getElementById('restartBtn');
const musicBtn = document.getElementById('musicBtn');

const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');
const bgMusic = document.getElementById('bgMusic');

// Load images ‚Äî note: filenames have .jfif appended as you requested
function loadImg(src){
  const img = new Image();
  img.src = src;
  img._loaded = false;
  img._fail = false;
  img.onload = () => img._loaded = true;
  img.onerror = () => { img._fail = true; img._loaded = true; };
  return img;
}
const bgImg = loadImg('background.jpg.jfif');
const imgNeutral = loadImg('character_neutral.png.jfif');
const imgHappy = loadImg('character_happy.png.jfif');
const imgSad = loadImg('character_sad.png.jfif');

/* ========== Questions (correct is 1..4) ========== */
const questions = [
  {
    question: "Hi·ªán nay, nh·ªØng qu·ªëc gia n√†o v·∫´n ki√™n ƒë·ªãnh con ƒë∆∞·ªùng x√¢y d·ª±ng ch·ªß nghƒ©a x√£ h·ªôi?",
    answers: [
      "A. Trung Qu·ªëc, Vi·ªát Nam, Cuba, L√†o",
      "B. Trung Qu·ªëc, Nga, Vi·ªát Nam, Cam-pu-chia",
      "C. Vi·ªát Nam, Cuba, H√†n Qu·ªëc, L√†o",
      "D. Cuba, Trung Qu·ªëc, Cam-pu-chia, Nh·∫≠t B·∫£n"
    ],
    correct: 1
  },
  {
    question: "Ai l√† ng∆∞·ªùi kh·ªüi x∆∞·ªõng c√¥ng cu·ªôc c·∫£i c√°ch v√† m·ªü c·ª≠a Trung Qu·ªëc t·ª´ nƒÉm 1978?",
    answers: ["A. Mao Tr·∫°ch ƒê√¥ng","B. ƒê·∫∑ng Ti·ªÉu B√¨nh","C. Giang Tr·∫°ch D√¢n","D. T·∫≠p C·∫≠n B√¨nh"],
    correct: 2
  },
  {
    question: "Nh·ªØng th√†nh t·ª±u c·ªßa c√¥ng cu·ªôc ƒë·ªïi m·ªõi, c·∫£i c√°ch ·ªü ch√¢u √Å, khu v·ª±c M·ªπ La-tinh l√† c∆° s·ªü v·ªØng ch·∫Øc ƒë·ªÉ ch·ª©ng minh",
    answers: [
      "A. ch·ªß nghƒ©a x√£ h·ªôi c√≥ s·ª©c s·ªëng, c√≥ tri·ªÉn v·ªçng th·ª±c s·ª± tr√™n th·∫ø gi·ªõi.",
      "B. ch·ªß nghƒ©a t∆∞ b·∫£n kh√¥ng c√≤n l√† m·ªôt h·ªá th·ªëng duy nh·∫•t tr√™n th·∫ø gi·ªõi.",
      "C. ch·ªß nghƒ©a x√£ h·ªôi ng√†y c√†ng ph√°t tri·ªÉn v√† m·ªü r·ªông v·ªÅ kh√¥ng gian ƒë·ªãa l√≠.",
      "D. ch·ªß nghƒ©a x√£ h·ªôi ƒë√£ tr·ªü th√†nh m·ªôt h·ªá th·ªëng tr√™n ph·∫°m vi th·∫ø gi·ªõi."
    ],
    correct: 1
  },
  {
    question: "T·ª´ c√¥ng cu·ªôc c·∫£i c√°ch m·ªü c·ªßa Trung Qu·ªëc, Vi·ªát Nam c√≥ th·ªÉ r√∫t ra b√†i h·ªçc kinh nghi·ªám g√¨?",
    answers: [
      "A. L·∫•y ph√°t tri·ªÉn kinh t·∫ø l√†m trung t√¢m, chuy·ªÉn sang n·ªÅn kinh t·∫ø th·ªã tr∆∞·ªùng TBCN.",
      "B. L·∫•y ph√°t tri·ªÉn kinh t·∫ø l√†m trung t√¢m, ti·∫øn h√†nh c·∫£i c√°ch m·ªü c·ª≠a, chuy·ªÉn sang kinh t·∫ø th·ªã tr∆∞·ªùng t·ª± do.",
      "C. L·∫•y ph√°t tri·ªÉn ch√≠nh tr·ªã l√†m trung t√¢m, chuy·ªÉn sang kinh t·∫ø th·ªã tr∆∞·ªùng XHCN.",
      "D. L·∫•y ph√°t tri·ªÉn kinh t·∫ø l√†m trung t√¢m, ti·∫øn h√†nh c·∫£i c√°ch m·ªü c·ª≠a, chuy·ªÉn n·ªÅn kinh t·∫ø t·∫≠p trung sang n·ªÅn kinh t·∫ø th·ªã tr∆∞·ªùng XHCN."
    ],
    correct: 4
  },
  {
    question: "M·ª•c ti√™u l√¢u d√†i c·ªßa Vi·ªát Nam trong qu√° tr√¨nh x√¢y d·ª±ng CNXH l√†:",
    answers: [
      "A. D√¢n gi√†u, n∆∞·ªõc m·∫°nh, d√¢n ch·ªß, c√¥ng b·∫±ng, vƒÉn minh",
      "B. Kinh t·∫ø t∆∞ b·∫£n ph√°t tri·ªÉn",
      "C. C√¥ng nghi·ªáp h√≥a b·∫±ng m·ªçi gi√°",
      "D. Gi·∫£m vai tr√≤ c·ªßa nh√† n∆∞·ªõc"
    ],
    correct: 1
  }
];

/* ========== Game state ========== */
let idx = 0;
let score = 0;
let showResult = false;
let gameEnded = false;
let charState = 'neutral'; // 'neutral' | 'happy' | 'sad'

/* Animation variables */
let tick = 0;

/* ========== Drawing ========== */
function drawBackground() {
  if (bgImg._loaded && !bgImg._fail) {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  } else {
    // fallback background
    ctx.fillStyle = '#f7fbff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    // light grid for nice look
    ctx.strokeStyle = '#eef5ff';
    for (let x = 0; x < canvas.width; x += 40) {
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
    }
  }
}

function drawCharacter() {
  const w = 170, h = 170;
  const baseX = canvas.width/2 - w/2;
  // bounce effect
  const bounce = Math.sin(tick/10) * 8;
  const x = baseX;
  const y = 80 + bounce;
  const img = charState === 'happy' ? imgHappy : (charState === 'sad' ? imgSad : imgNeutral);

  ctx.save();
  // subtle tilt based on state
  const tilt = (charState === 'sad' ? -4 : (charState === 'happy' ? 4 : 0)) * Math.PI / 180;
  ctx.translate(x + w/2, y + h/2);
  ctx.rotate(tilt);
  if (img._loaded && !img._fail) {
    ctx.drawImage(img, -w/2, -h/2, w, h);
  } else {
    // fallback box + emoji
    ctx.fillStyle = '#cfd8e3';
    ctx.fillRect(-w/2, -h/2, w, h);
    ctx.fillStyle = '#2b3a55';
    ctx.font = '48px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const emoji = charState === 'happy' ? 'üòä' : (charState === 'sad' ? 'üò¢' : 'üòê');
    ctx.fillText(emoji, 0, 0);
  }
  ctx.restore();
}

function drawQuestionArea() {
  const qObj = questions[idx];
  ctx.fillStyle = '#0b2545';
  ctx.font = 'bold 22px Arial';
  ctx.textAlign = 'left';
  wrapText(qObj.question, 40, 280, 720, 28);

  // answers
  ctx.font = '18px Arial';
  for (let i = 0; i < qObj.answers.length; i++) {
    const text = `${i+1}. ${qObj.answers[i]}`;
    ctx.fillStyle = '#06263b';
    ctx.fillText(text, 60, 330 + i*40);
  }

  // info
  ctx.fillStyle = '#0b2545';
  ctx.font = '16px Arial';
  ctx.fillText(`C√¢u ${idx+1}/${questions.length}    ƒêi·ªÉm: ${score}`, 40, 40);
}

function wrapText(text, x, y, maxWidth, lineHeight) {
  const words = text.split(' ');
  let line = '';
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + ' ';
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}

/* Main draw */
function render() {
  tick++;
  // draw
  drawBackground();
  drawCharacter();
  drawQuestionArea();

  // show small result text
  if (showResult) {
    ctx.fillStyle = (charState === 'happy') ? '#1b7a2f' : '#b92b2b';
    ctx.font = '22px Arial';
    ctx.textAlign = 'center';
    ctx.fillText((charState === 'happy') ? '‚úì ƒê√∫ng r·ªìi!' : '‚úó Sai r·ªìi!', canvas.width/2, 480);
  }

  if (!gameEnded) requestAnimationFrame(render);
  else {
    // draw end summary
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#0b2545';
    ctx.font = '28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Tr√≤ ch∆°i k·∫øt th√∫c!', canvas.width/2, 180);
    ctx.font = '22px Arial';
    ctx.fillText(`ƒêi·ªÉm c·ªßa b·∫°n: ${score}/${questions.length}`, canvas.width/2, 230);
  }
}

/* ========== Input handling ========== */
function tryPlayAudio(audioEl){
  if(!audioEl) return;
  try{
    const p = audioEl.play();
    if(p && p.catch) p.catch(()=>{/* ignore autoplay blocked */});
  }catch(e){}
}

document.addEventListener('keydown', (ev) => {
  if (gameEnded) return;
  if (showResult) return; // ignore while result shown
  const key = parseInt(ev.key);
  if (!isNaN(key) && key >= 1 && key <= 4) {
    const qObj = questions[idx];
    const correct = (key === qObj.correct);
    showResult = true;
    if (correct) {
      charState = 'happy';
      score++;
      tryPlayAudio(correctSound);
    } else {
      charState = 'sad';
      tryPlayAudio(wrongSound);
    }
    // show result briefly then next question or end
    setTimeout(() => {
      idx++;
      showResult = false;
      charState = 'neutral';
      if (idx >= questions.length) {
        gameEnded = true;
      }
    }, 1300);
  }
});

/* Restart & music button */
restartBtn.addEventListener('click', () => {
  idx = 0; score = 0; gameEnded = false; showResult = false; charState = 'neutral';
  // ensure render loop active
  requestAnimationFrame(render);
});
let musicOn = false;
musicBtn.addEventListener('click', () => {
  musicOn = !musicOn;
  if (musicOn) {
    tryPlayAudio(bgMusic);
    musicBtn.textContent = 'üîà T·∫Øt nh·∫°c';
  } else {
    try { bgMusic.pause(); } catch(e){}
    musicBtn.textContent = 'üîä B·∫≠t/T·∫Øt nh·∫°c';
  }
});

/* Start render */
requestAnimationFrame(render);
</script>
</body>
</html>
